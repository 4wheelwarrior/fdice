<html>
<head>
<title>FDICE</title>
<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1, minimum-scale=1.0, width=device-width, height=device-height, target-densitydpi=device-dpi" />
<!-- note: Try replacing device-dpi by medium-dpi. device-dpi prevents default scaling, while medium-dpi will scale down on low density screens and scale up on high density screens. -->
<style>
	body{
		background: #333 ;
		padding: 0 ;
		margin: 0 ;
	}

	#ver{
		position: absolute ;
		z-index: 1000 ;
		background: black ;
		width: 80px ;
		height: 30px ;
		padding: 4px ;
		color: white ;
	}

	#r1{
		position: absolute ;

		left: 100px ;
		z-index: 1000 ;
		background: black ;
		width: 80px ;
		height: 30px ;
		padding: 4px ;
		color: white ;
	}

	#r2{
		position: absolute ;

		left: 200px ;
		z-index: 1000 ;
		background: black ;
		width: 80px ;
		height: 30px ;
		padding: 4px ;
		color: white ;
	}

	#dice{
		position: absolute ;
		z-index: 400 ;

		width: 480px ;
		height: 800px ;

		background: url('bg2.gif') ;
	}

	#fart{
		display: block ;
		position: absolute ;
		left: 400px ;
		top: 200px ;

		font-size: 28px ;
		font-family: tahoma, arial, helvetica, verdana, sans-serif ;

		width: 200px ;
		height: 80px ;

		text-align: center ;

		background: green ;

		border: 4px solid #003300 ;
		color: white ;
		font-weight: bold ;
	}

	#dbg{
		display: block ;
		position: absolute ;
		left: 400px ;
		top: 400px ;

		font-size: 16px ;
		font-family: tahoma, arial, helvetica, verdana, sans-serif ;

		width: 200px ;
		height: 80px ;

		text-align: center ;

		background: black ;

		border: 4px solid #000 ;
		color: white ;
		font-weight: bold ;
	}

	#dice-frames{
		position: absolute ;
		z-index: 0 ;
		width: 1px ;
		height: 1px ;
		overflow: hidden ;
	}

</style>
<script src="phonegap.js"></script>
<script>
	var dt1 = 0 ;
	var dt2 = 0 ;

	var df1 = 1 ;
	var df2 = 1 ;

	var r1 = 0 ;
	var r2 = 0 ;

	// (R)oll (C)ompleted flags
	// reset to false on every roll
	// set to true once roll anim is complete
	var rc1 = false ;
	var rc2 = false ;

	var _IUD = {} ; // update interval
	var _AFS = {} ; // farting sprite

	var _CTX = {} ; // dice context

	// frame counts
	// indices are roll types (d-N-f.png)
	// N = 0, 1, 2, 3 ...  f = 1, 2, 3 ...
	var _DT = [ 22, 26, 21, 11, 24, 25, 25 ] ;
	// Center Line X offsets
	// ( d1 and d2 are offset - and + from center line
    //   to prevent excessive dice overlap )
	var _DC = [ -50, -75, -25, 50, -25, -50, -25 ] ;

	var _ARO = {}	// rolling sounds
	var _AFR = {}   // farting sounds

	var _dsa = false ; // DiSAble audio bit

	function main(){
		initDiceFrames() ;

		initRollAudio() ;
		initFartAudio() ;


		_CTX = getID('dice').getContext('2d') ;

		_IUD = window.setInterval( update, 60 ) ;
		_AFS = document.getElementById( 'afs' ) ;

		getID('dice').addEventListener( 'click', roll, false ) ;
	}

	function initRollAudio(){
		if( _dsa == true ) return ;

		for( var i = 1; i < 7; i++ ){
			_ARO[i] = new Media( '/android_asset/www/rol-' + i + '.wav' ) ;
		}
	}

	function initFartAudio(){
		if( _dsa == true ) return ;

		for( var i = 1; i < 7; i++ ){
			_AFR[i] = new Media( '/android_asset/www/frt-' + i + '.wav' ) ;
		}
	}

	function initDiceFrames(){
		var img ;

		// OUTER LOOP: ROLL ANIM TYPE (0 - N)
		for( var i = 0; i < _DT.length; i++ ){
			// INNER LOOP: FRAME COUNT (REFC'D FROM _DT ARRAY)
			for( var j = 1; j <= _DT[i]; j++ ){
				img = document.createElement('img') ;

				img.src = 'd-' + i + '-' + j + '.png' ;
				img.id =  'd-' + i + '-' + j ;

				// console.log('generated img id: ' + img.id) ;

				getID('dice-frames').appendChild( img ) ;
			}
		}
	}

	function roll(){
		rc1 = false ;
		rc2 = false ;
		// dt1 = _DT[ randomInt( 0, 3 ) ] ;
		// dt2 = dt1 ;

		// while( dt2 == dt1 ){
		// 	dt2 = _DT[ randomInt( 0, 3 ) ] ;
		// }


		dt1 = randomInt( 0, ( _DT.length - 1 ) ) ;
		dt2 = dt1 ;

		while( dt2 == dt1 ){
			dt2 = randomInt( 0, ( _DT.length - 1 ) ) ;
		}


		r1 = randomInt( 1, 6 ) ;
		r2 = randomInt( 1, 6 ) ;

		getID( 'r1' ).innerHTML = r1 ;
		getID( 'r2' ).innerHTML = r2 ;

		df1 = 1 ;
		df2 = 1 ;

		rsnd() ;

		window.setTimeout( fart, 2000 ) ;
	}

	function update(){
		// Total X offsets for D1 and D2
		// Computed from _DC values
		// D1 goes RIGHT, D2 goes LEFT of center
		var x1 = _DC[ dt1 ] + 100 ;
		var x2 = _DC[ dt2 ] - 100 ;

		df1++ ;
		df2++ ;

		// console.log('df1 = ' + df1 ) ;
		// console.log('df2 = ' + df2 ) ;


		// LIMIT CONDITION FOR DICE 1
		if( ( df1 > _DT[ dt1 ] ) ){
			df1 = _DT[ dt1 ] ;
			rc1 = true ;
		}

		// LIMIT CONDITION FOR DICE 2
		if( ( df2 > _DT[ dt2 ] ) ){
			df2 = _DT[ dt2 ] ;
			rc2 = true
		}

		_CTX.clearRect( 0, 0, 480, 800 ) ;

		_CTX.drawImage( getID( 'd-' + dt1 + '-' + df1 ), x1, 0, 480, 800 ) ;
		_CTX.drawImage( getID( 'd-' + dt2 + '-' + df2 ), x2, 0, 480, 800 ) ;

		// if( rc1 == true && rc2 == true ){
		// 	fart() ;
		// }
	}

	function fart(){
		// if rolls haven't completed yet, wait, try again
		if( rc1 == false && rc2 == false ){
			window.setTimeout( fart, 1000 ) ;
			return ;
		}

		fart1() ;
		window.setTimeout( fart2, 200 ) ;
	}

	function fart1(){
		df1 = df1 - 5 ;

		if( _dsa == true ) return ;
		_AFR[ r1 ].play() ;
	}

	function fart2(){
		df2 = df2 - 5 ;

		if( _dsa == true ) return ;
		_AFR[ r2 ].play() ;
	}

	function rsnd(){
		var i = randomInt( 1, 6 ) ;

		if( _dsa == true ) return ;
		_ARO[i].play() ;
	}

	function getID( id ){
		return document.getElementById(id) ;
	}

	function randomInt( min, max ){
		return Math.floor( Math.random() * (max - min + 1)) + min ;
	}

	function dbg( msg ){
		getID('dbg').innerHTML = msg ;
	}
</script>
</head>

<body id="thebody" onload="main()">
	<div id="ver">5</div>
	<div id="r1">0</div>
	<div id="r2">0</div>


	<canvas id="dice" width="480" height="800"></canvas>
<!-- 
	<div id="dbg"></div>

	<a id="roll" href="javascript:roll()">ROL</a>
	<a id="fart" href="javascript:fart()">FRT</a>
 -->
	<audio id="aro">
		<source src="aro.wav" type="audio/wav">
	</audio>

	<audio id="afs1">
		<source src="afs.wav" type="audio/wav">
	</audio>

	<audio id="afs2">
		<source src="afs.wav" type="audio/wav">
	</audio>

	<div id="dice-frames"></div>
</body>

</html>